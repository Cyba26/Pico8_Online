<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
<title>PICO-8 Web Launcher</title>
<link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAABZUlEQVR4Ae3dIY4CMRiA0SlBcRGynmuAISEcgGvggGRXrl25GgUHAC6B4AB4LvCvXgTB/JN05j2JaDvtR2sbAKCXStc+KJpp5G7YoVN7NvAf6DcBCAABIAAEgAAQAAJAAAgAASAABIAAEAACQAAIAAEgAASAAKjdsO0J47eJ1AlmP7nrv11S118mi+IGQAAIAAEgAASAABAAAkAACAABIAAEgAAQAAJAAAgAASAABIAAeFN5/iFiHKkzPs52/ZXdKffAP5f/ztwN4AlAAAgAASAABIAAEAACQAAIAAEgAASAABAAAkAACAABIAAEQNVK6zPeF5E5fIy+U5e/2R5Tx19/rVo9EzeAJwABIAAEgAAQAAJAAAgAASAABIAAEAACQAAIAAEgAASAABAAVStd+6CPfUTm+Nd56dSeuQE8AQgAASAABIAAEAACQAAIAAEgAASAABAAAkAACAABIAAEgAAAAKjOH1O0HaDSiFpiAAAAEHRFWHRMb2RlUE5HADIwMTEwMjIx41m2wQAAAABJRU5ErkJggg==">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0d0d1a;--surface:#151528;--border:#252540;
  --accent:#ff004d;--accent-glow:#ff004d60;
  --green:#00e436;--blue:#29adff;--yellow:#ffec27;
  --pink:#ff77a8;--lavender:#83769c;
  --text:#fff;--text2:#7e7592;
}
body{
  font-family:'Courier New',monospace;
  background:var(--bg);color:var(--text);
  min-height:100vh;min-height:100dvh;
  display:flex;flex-direction:column;align-items:center;
  background-image:
    radial-gradient(ellipse at 20% 50%,#1a0a2e 0%,transparent 50%),
    radial-gradient(ellipse at 80% 20%,#0a1a2e 0%,transparent 50%);
}

/* ===== LOADING ===== */
#step-loading{max-width:480px;width:100%;padding:20px 16px;display:flex;flex-direction:column;align-items:center;gap:16px}
.logo{text-align:center;padding:24px 0 8px}
.logo img{height:40px;image-rendering:pixelated;filter:drop-shadow(0 0 12px var(--accent-glow))}
.logo .sub{font-size:10px;color:var(--text2);margin-top:8px;letter-spacing:1px}
.load-status{font-size:11px;color:var(--text2);text-align:center;line-height:1.8}
.spinner{display:inline-block;width:16px;height:16px;border:2px solid var(--border);
  border-top-color:var(--blue);border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle;margin-right:6px}
@keyframes spin{to{transform:rotate(360deg)}}

/* ===== SETUP ===== */
#step-setup{max-width:480px;width:100%;padding:20px 16px;display:none;flex-direction:column;gap:16px;align-items:center}
#step-setup.on{display:flex}
.card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:18px;width:100%;transition:border-color .3s}
.card-head{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.badge{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:bold;background:var(--accent);color:#fff;flex-shrink:0}
.card-title{font-size:12px;font-weight:bold}
.card-desc{font-size:10px;color:var(--text2);margin-bottom:10px;line-height:1.5}
.dropzone{border:2px dashed var(--border);border-radius:8px;padding:24px 12px;text-align:center;cursor:pointer;transition:all .2s;font-size:11px;color:var(--text2);position:relative;overflow:hidden}
.dropzone:hover,.dropzone.over{border-color:var(--accent);background:#ff004d08;color:var(--text)}
.dropzone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;z-index:1}
.pbar{height:3px;background:#ffffff08;border-radius:2px;margin-top:8px;display:none;overflow:hidden}
.pbar.on{display:block}
.pfill{height:100%;background:var(--accent);width:0%;transition:width .25s;border-radius:2px}
.log{font-size:9px;color:var(--text2);max-height:70px;overflow-y:auto;margin-top:6px;padding:5px;background:#00000040;border-radius:3px;display:none;line-height:1.6;scrollbar-width:thin;scrollbar-color:var(--border) transparent}
.log.on{display:block}
.log .g{color:var(--green)}.log .r{color:var(--accent)}.log .b{color:var(--blue)}

/* ===== LIBRARY ===== */
#step-library{display:none;width:100%;max-width:600px;padding:12px 16px;flex-direction:column;gap:14px}
#step-library.on{display:flex}
.lib-header{display:flex;align-items:center;justify-content:space-between;gap:8px}
.lib-header img{height:28px;image-rendering:pixelated}
.lib-header-right{display:flex;gap:6px;align-items:center}
.reset-btn,.admin-btn{font-size:9px;color:var(--text2);background:none;border:1px solid var(--border);padding:3px 8px;border-radius:4px;cursor:pointer;font-family:inherit;transition:all .15s}
.reset-btn:hover{border-color:var(--accent);color:var(--accent)}
.admin-btn:hover{border-color:var(--blue);color:var(--blue)}
.admin-btn.active{border-color:var(--green);color:var(--green)}
.lib-drop{border:2px dashed var(--border);border-radius:8px;padding:16px;text-align:center;cursor:pointer;transition:all .2s;font-size:11px;color:var(--text2);position:relative;overflow:hidden}
.lib-drop:hover,.lib-drop.over{border-color:var(--blue);background:#29adff08;color:var(--text)}
.lib-drop input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;z-index:1}
.admin-zone{display:none;flex-direction:column;gap:10px}
.admin-zone.on{display:flex}
.admin-section{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px}
.admin-section-title{font-size:10px;color:var(--blue);margin-bottom:8px;font-weight:bold}
.rt-status{font-size:9px;color:var(--green);padding:4px 0}
.rt-status.none{color:var(--accent)}

.cart-grid{display:flex;flex-direction:column;gap:20px;margin-top:4px}
.cart-section-title{font-size:15px;color:var(--text);font-weight:bold;margin-bottom:10px;padding-bottom:6px;border-bottom:2px solid var(--border);letter-spacing:.3px}
.cart-grid-inner{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.cart-grid-inner.featured{grid-template-columns:repeat(2,1fr)}
.cart-cat-select{width:100%;font-size:8px;font-family:inherit;background:var(--surface);color:var(--text2);border:none;border-top:1px solid var(--border);padding:3px 6px;cursor:pointer;outline:none;position:relative;z-index:3}
.cart-cat-select:hover{color:var(--blue);background:var(--bg)}
.cat-item{display:flex;align-items:center;gap:6px;padding:5px 0;border-bottom:1px solid var(--border)}
.cat-item:last-child{border-bottom:none}
.cat-name{flex:1;font-size:11px;color:var(--text);cursor:pointer;padding:2px 4px;border-radius:3px}
.cat-name:hover{color:var(--blue);background:#29adff10}
.cat-name input{width:100%;background:var(--bg);border:1px solid var(--blue);color:var(--text);font-size:11px;font-family:inherit;padding:2px 6px;border-radius:3px;outline:none}
.cat-del{font-size:10px;color:var(--text2);background:none;border:none;cursor:pointer;padding:2px 4px;line-height:1}
.cat-del:hover{color:var(--accent)}
.cat-pin{font-size:10px;color:var(--text2);background:none;border:none;cursor:pointer;padding:2px 4px;line-height:1}
.cat-pin:hover{color:#ffd700}
.cat-add-btn{width:100%;font-size:10px;color:var(--text2);background:none;border:1px dashed var(--border);padding:5px;border-radius:4px;cursor:pointer;font-family:inherit;margin-top:6px;transition:all .15s}
.cat-add-btn:hover{border-color:var(--blue);color:var(--blue)}
.cart-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;overflow:hidden;cursor:pointer;transition:all .2s;position:relative}
.cart-card:hover{border-color:var(--blue);transform:translateY(-2px);box-shadow:0 4px 16px #29adff20}
.cart-card:active{transform:translateY(0)}
.cart-card .thumb{width:100%;aspect-ratio:160/205;background:#000;display:flex;align-items:center;justify-content:center;overflow:hidden}
.cart-card .thumb img{width:100%;height:100%;object-fit:cover;image-rendering:pixelated}
.cart-card .cname{padding:6px 8px;font-size:10px;text-align:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text2)}
.cart-card .play-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.5);opacity:0;transition:opacity .2s;font-size:28px;color:#fff;pointer-events:none}
.cart-card:hover .play-overlay{opacity:1}
.cart-card .delete-btn{position:absolute;top:4px;right:4px;width:18px;height:18px;border-radius:50%;background:#000a;border:1px solid #fff2;color:#fff8;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .15s;z-index:2;line-height:1}
.cart-card:hover .delete-btn{opacity:1}
.cart-card .delete-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
/* Trophy icon on cards with leaderboard */
.cart-card .trophy-icon{position:absolute;top:4px;left:4px;font-size:12px;opacity:.7}

.empty-lib{text-align:center;padding:32px 16px;color:var(--text2);font-size:11px;line-height:1.8}
.loading-lib{text-align:center;padding:32px 16px;color:var(--text2);font-size:11px}

/* ===== LEADERBOARD PAGE ===== */
#step-leaderboard{display:none;width:100%;max-width:500px;padding:12px 16px;flex-direction:column;gap:14px}
#step-leaderboard.on{display:flex}
.lb-header{display:flex;align-items:center;justify-content:space-between}
.lb-back{font-size:9px;color:var(--text2);background:none;border:1px solid var(--border);padding:3px 8px;border-radius:4px;cursor:pointer;font-family:inherit;transition:all .15s}
.lb-back:hover{border-color:var(--blue);color:var(--blue)}
.lb-title{font-size:14px;font-weight:bold;text-align:center}
.lb-game-name{font-size:10px;color:var(--blue);text-align:center;margin-top:2px}
.lb-play-btn{
  display:block;margin:0 auto;padding:8px 24px;background:var(--accent);color:#fff;
  border:none;border-radius:6px;font-family:inherit;font-size:12px;cursor:pointer;
  transition:all .15s;font-weight:bold;
}
.lb-play-btn:hover{opacity:.85;transform:scale(1.02)}

.lb-table{width:100%;border-collapse:collapse;margin-top:4px}
.lb-table th{font-size:9px;color:var(--text2);text-align:left;padding:6px 8px;border-bottom:1px solid var(--border);text-transform:uppercase;letter-spacing:.5px}
.lb-table th:last-child{text-align:right}
.lb-table td{font-size:11px;padding:8px;border-bottom:1px solid var(--border);color:var(--text)}
.lb-table td:last-child{text-align:right;font-weight:bold;color:var(--yellow)}
.lb-table tr:nth-child(-n+3) td:first-child{color:var(--yellow)}
.lb-table .rank-1{color:var(--yellow)}
.lb-table .rank-2{color:var(--lavender)}
.lb-table .rank-3{color:var(--pink)}
.lb-empty{text-align:center;padding:24px;color:var(--text2);font-size:11px}
.lb-filter{font-size:9px;color:var(--text2);background:none;border:1px solid var(--border);padding:3px 10px;border-radius:4px;cursor:pointer;font-family:inherit;transition:all .15s}
.lb-filter:hover{border-color:var(--blue);color:var(--blue)}
.lb-filter.active{border-color:var(--blue);color:var(--blue);background:#29adff15}

/* ===== MODALS ===== */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:400;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal-overlay.on{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:24px;width:90%;max-width:320px;text-align:center}
.modal h3{font-size:13px;margin-bottom:12px;font-family:inherit}
.modal input{width:100%;padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:inherit;font-size:12px;outline:none;margin-bottom:12px}
.modal input:focus{border-color:var(--blue)}
.modal-btns{display:flex;gap:8px;justify-content:center}
.modal-btns button{padding:6px 16px;border-radius:6px;font-family:inherit;font-size:11px;cursor:pointer;border:1px solid var(--border);transition:all .15s}
.modal-btns .btn-cancel{background:none;color:var(--text2)}
.modal-btns .btn-cancel:hover{border-color:var(--accent);color:var(--accent)}
.modal-btns .btn-ok{background:var(--blue);color:#fff;border-color:var(--blue)}
.modal-btns .btn-ok:hover{opacity:.85}
.modal .error-msg{font-size:10px;color:var(--accent);margin-bottom:8px;display:none}
.modal .score-display{font-size:24px;color:var(--yellow);margin:8px 0 16px;font-weight:bold}

/* ===== GAME ===== */
#game{display:none;position:fixed;inset:0;background:#000;z-index:100}
#game iframe{width:100%;height:100%;border:none}
#close-btn{position:fixed;top:10px;right:10px;z-index:200;width:36px;height:36px;border-radius:50%;background:rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.15);color:rgba(255,255,255,.8);font-size:18px;line-height:1;cursor:pointer;display:none;backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);transition:all .15s;align-items:center;justify-content:center}
#close-btn.on{display:flex}
#close-btn:hover{background:var(--accent);border-color:var(--accent);color:#fff;transform:scale(1.1)}

::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(60px);background:var(--surface);border:1px solid var(--border);color:var(--text);padding:8px 16px;border-radius:6px;font-size:11px;font-family:inherit;transition:transform .3s,opacity .3s;opacity:0;z-index:300;white-space:nowrap}
#toast.on{transform:translateX(-50%) translateY(0);opacity:1}
</style>
</head>
<body>

<!-- LOADING -->
<div id="step-loading">
  <div class="logo">
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAABZUlEQVR4Ae3dIY4CMRiA0SlBcRGynmuAISEcgGvggGRXrl25GgUHAC6B4AB4LvCvXgTB/JN05j2JaDvtR2sbAKCXStc+KJpp5G7YoVN7NvAf6DcBCAABIAAEgAAQAAJAAAgAASAABIAAEAACQAAIAAEgAASAAKjdsO0J47eJ1AlmP7nrv11S118mi+IGQAAIAAEgAASAABAAAkAACAABIAAEgAAQAAJAAAgAASAABIAAeFN5/iFiHKkzPs52/ZXdKffAP5f/ztwN4AlAAAgAASAABIAAEAACQAAIAAEgAASAABAAAkAACAABIAAEQNVK6zPeF5E5fIy+U5e/2R5Tx19/rVo9EzeAJwABIAAEgAAQAAJAAAgAASAABIAAEAACQAAIAAEgAASAABAAVStd+6CPfUTm+Nd56dSeuQE8AQgAASAABIAAEAACQAAIAAEgAASAABAAAkAACAABIAAEgAAAAKjOH1O0HaDSiFpiAAAAEHRFWHRMb2RlUE5HADIwMTEwMjIx41m2wQAAAABJRU5ErkJggg==" alt="PICO-8">
    <div class="sub">web launcher</div>
  </div>
  <div class="load-status" id="load-status"><span class="spinner"></span> Loading...</div>
</div>

<!-- SETUP -->
<div id="step-setup">
  <div class="logo"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAABZUlEQVR4Ae3dIY4CMRiA0SlBcRGynmuAISEcgGvggGRXrl25GgUHAC6B4AB4LvCvXgTB/JN05j2JaDvtR2sbAKCXStc+KJpp5G7YoVN7NvAf6DcBCAABIAAEgAAQAAJAAAgAASAABIAAEAACQAAIAAEgAASAAKjdsO0J47eJ1AlmP7nrv11S118mi+IGQAAIAAEgAASAABAAAkAACAABIAAEgAAQAAJAAAgAASAABIAAeFN5/iFiHKkzPs52/ZXdKffAP5f/ztwN4AlAAAgAASAABIAAEAACQAAIAAEgAASAABAAAkAACAABIAAEQNVK6zPeF5E5fIy+U5e/2R5Tx19/rVo9EzeAJwABIAAEgAAQAAJAAAgAASAABIAAEAACQAAIAAEgAASAABAAVStd+6CPfUTm+Nd56dSeuQE8AQgAASAABIAAEAACQAAIAAEgAASAABAAAkAACAABIAAEgAAAAKjOH1O0HaDSiFpiAAAAEHRFWHRMb2RlUE5HADIwMTEwMjIx41m2wQAAAABJRU5ErkJggg==" alt="PICO-8"><div class="sub">web launcher</div></div>
  <div class="card" id="s1">
    <div class="card-head"><div class="badge">!</div><div class="card-title">Runtime not available</div></div>
    <div class="card-desc">The PICO-8 runtime hasn't been uploaded yet.<br>Ask the admin to upload it, or drop your <b>pico8.dat</b> below for local use.</div>
    <div class="dropzone" id="dz1">Drop pico8.dat here — or tap to browse<input type="file" id="f1" accept=".dat"></div>
    <div class="pbar" id="pb1"><div class="pfill" id="pf1"></div></div>
    <div class="log" id="log1"></div>
  </div>
</div>

<!-- LIBRARY -->
<div id="step-library">
  <div class="lib-header">
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAABZUlEQVR4Ae3dIY4CMRiA0SlBcRGynmuAISEcgGvggGRXrl25GgUHAC6B4AB4LvCvXgTB/JN05j2JaDvtR2sbAKCXStc+KJpp5G7YoVN7NvAf6DcBCAABIAAEgAAQAAJAAAgAASAABIAAEAACQAAIAAEgAASAAKjdsO0J47eJ1AlmP7nrv11S118mi+IGQAAIAAEgAASAABAAAkAACAABIAAEgAAQAAJAAAgAASAABIAAeFN5/iFiHKkzPs52/ZXdKffAP5f/ztwN4AlAAAgAASAABIAAEAACQAAIAAEgAASAABAAAkAACAABIAAEQNVK6zPeF5E5fIy+U5e/2R5Tx19/rVo9EzeAJwABIAAEgAAQAAJAAAgAASAABIAAEAACQAAIAAEgAASAABAAVStd+6CPfUTm+Nd56dSeuQE8AQgAASAABIAAEAACQAAIAAEgAASAABAAAkAACAABIAAEgAAAAKjOH1O0HaDSiFpiAAAAEHRFWHRMb2RlUE5HADIwMTEwMjIx41m2wQAAAABJRU5ErkJggg==" alt="PICO-8" style="height:28px;image-rendering:pixelated">
    <div class="lib-header-right">
      <button class="admin-btn" id="admin-toggle">&#x1F512; Admin</button>
    </div>
  </div>
  <div class="admin-zone" id="admin-zone">
    <div class="admin-section">
      <div class="admin-section-title">Runtime (.dat)</div>
      <div class="rt-status" id="rt-status"></div>
      <div class="lib-drop" id="dz-rt">Upload / replace pico8.dat for all users<input type="file" id="f-rt" accept=".dat"></div>
    </div>
    <div class="admin-section">
      <div class="admin-section-title">Add cartridges</div>
      <div class="lib-drop" id="dz2">+ Drop .p8.png cartridges here — or tap to browse<input type="file" id="f2" accept=".png" multiple></div>
    </div>
    <div class="admin-section">
      <div class="admin-section-title">Catégories</div>
      <div id="cat-list"></div>
      <button class="cat-add-btn" id="cat-add">+ Nouvelle catégorie</button>
    </div>
  </div>
  <div id="cart-area">
    <div class="loading-lib" id="loading-msg" style="display:none"><span class="spinner"></span> Loading cartridges...</div>
    <div class="empty-lib" id="empty-msg" style="display:none">No cartridges yet.</div>
    <div class="cart-grid" id="cart-grid"></div>
  </div>
</div>

<!-- LEADERBOARD PAGE -->
<div id="step-leaderboard">
  <div class="lb-header">
    <button class="lb-back" id="lb-back">&larr; Back</button>
    <div></div>
  </div>
  <div class="lb-title" id="lb-title">&#x1F3C6; Leaderboard</div>
  <div class="lb-game-name" id="lb-game-name"></div>
  <button class="lb-play-btn" id="lb-play-btn">&#x25B6; Play</button>
  <div style="display:flex;gap:6px;justify-content:center;margin-top:4px" id="lb-filters">
    <button class="lb-filter active" data-diff="all">All</button>
    <button class="lb-filter" data-diff="Easy">Easy</button>
    <button class="lb-filter" data-diff="Hard">Hard</button>
    <button class="lb-filter" data-diff="Nightmare">Nightmare</button>
  </div>
  <table class="lb-table" id="lb-table">
    <thead><tr><th>#</th><th>Player</th><th>Diff</th><th>Score</th></tr></thead>
    <tbody id="lb-body"></tbody>
  </table>
  <div class="lb-empty" id="lb-empty" style="display:none">No scores yet — be the first!</div>
</div>

<!-- ADMIN MODAL -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal">
    <h3>&#x1F512; Admin Login</h3>
    <div class="error-msg" id="modal-error"></div>
    <input type="email" id="modal-email" placeholder="Email" autocomplete="email">
    <input type="password" id="modal-pw" placeholder="Mot de passe" autocomplete="current-password">
    <div class="modal-btns">
      <button class="btn-cancel" id="modal-cancel">Cancel</button>
      <button class="btn-ok" id="modal-ok">Login</button>
    </div>
  </div>
</div>

<!-- SCORE SUBMIT MODAL -->
<div class="modal-overlay" id="score-overlay">
  <div class="modal">
    <h3>&#x1F3AE; Game Over!</h3>
    <div class="score-display" id="score-display">0</div>
    <div style="font-size:10px;color:var(--blue);margin:-12px 0 12px" id="score-diff"></div>
    <input type="text" id="score-name" placeholder="Enter your name" maxlength="20" autocomplete="off">
    <div class="modal-btns">
      <button class="btn-cancel" id="score-skip">Skip</button>
      <button class="btn-ok" id="score-submit">Submit Score</button>
    </div>
  </div>
</div>

<!-- GAME -->
<div id="game"><iframe id="gframe" sandbox="allow-scripts allow-same-origin"></iframe></div>
<button id="close-btn" title="Back to library">&#10005;</button>
<div id="toast"></div>

<script>
// ============================================================
//  CONFIG
// ============================================================
const SUPABASE_URL = 'https://lniliwvcdshrenxtxtzh.supabase.co';
const SUPABASE_ANON = 'sb_publishable_hHGxFFQrbORNGs-e5SVlPg_VyLnpRs4';
const RUNTIME_PATH = 'runtime/pico8.dat';

// Games that have leaderboards (match by cartridge name)
const LEADERBOARD_GAMES = ['shumpy jump', 'shumpy_jump', 'shumpyjump'];

// Cartridge categories — editable, persisted in localStorage
function loadCategories(){try{const s=localStorage.getItem('p8_categories');if(s){const p=JSON.parse(s);if(Array.isArray(p)&&p.length>0)return p}}catch(e){}return['Mes cartouches','Autres cartouches']}
function saveCategories(){
  localStorage.setItem('p8_categories',JSON.stringify(CART_CATEGORIES));
  // Sync vers Supabase en arrière-plan (cross-device)
  try{const blob=new Blob([JSON.stringify(CART_CATEGORIES)],{type:'application/json'});sb.storage.from('pico8').upload('config/categories.json',blob,{upsert:true}).catch(()=>{})}catch(e){}
}
async function loadCategoriesFromSupabase(){
  try{
    const{data}=sb.storage.from('pico8').getPublicUrl('config/categories.json');
    const resp=await fetch(data.publicUrl+'?t='+Date.now());
    if(resp.ok){const cats=await resp.json();if(Array.isArray(cats)&&cats.length>0){CART_CATEGORIES=cats;localStorage.setItem('p8_categories',JSON.stringify(CART_CATEGORIES));return}}
  }catch(e){}
}
let CART_CATEGORIES = loadCategories();

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

// ============================================================
//  LZ4
// ============================================================
function lz4Decompress(src, decompSize) {
  const out = new Uint8Array(decompSize); let si=0,di=0;
  while(si<src.length&&di<decompSize){const token=src[si++];let litLen=(token>>4)&0xF;if(litLen===15){let b;do{b=src[si++];litLen+=b}while(b===255)}if(si+litLen>src.length){out.set(src.subarray(si),di);break}out.set(src.subarray(si,si+litLen),di);si+=litLen;di+=litLen;if(di>=decompSize)break;if(si+2>src.length)break;const offset=src[si]|(src[si+1]<<8);si+=2;if(offset===0)break;let matchLen=(token&0xF)+4;if((token&0xF)===15){let b;do{b=src[si++];matchLen+=b}while(b===255)}let mPos=di-offset;if(mPos<0)break;for(let j=0;j<matchLen&&di<decompSize;j++)out[di++]=out[mPos+j]}
  return out;
}

// ============================================================
//  PARSER
// ============================================================
function parseDat(buf) {
  const d=new Uint8Array(buf),dv=new DataView(buf);const needle=[112,111,100,47,102,95,104,116,109,108,53,46,112,111,100];let namePos=-1;outer:for(let i=0;i<d.length-15;i++){for(let j=0;j<15;j++){if(d[i+j]!==needle[j])continue outer}namePos=i;break}if(namePos<0)throw new Error('pod/f_html5.pod not found');const firstCfil=namePos+64+76;const files={};const wanted=new Set(['src/pico8.js','src/shell.html','src/pico8_wasm.js','src/pico8_wasm.wasm']);let pos=firstCfil;
  while(pos+80<d.length){const m0=d[pos],m1=d[pos+1],m2=d[pos+2],m3=d[pos+3];const isCfil=(m0===99||m0===67)&&m1===70&&m2===73&&m3===76;if(!isCfil)break;const isCompressed=(m0===99);const uncompSize=dv.getUint32(pos+8,true);let ne=pos+12;while(ne<pos+76&&d[ne]!==0)ne++;const name=String.fromCharCode.apply(null,d.subarray(pos+12,ne));const dataStart=pos+76;const compSize=dv.getUint32(dataStart,true);const compData=d.subarray(dataStart+4,dataStart+4+compSize);if(wanted.has(name)){files[name.split('/').pop()]=isCompressed?lz4Decompress(compData,uncompSize):compData.slice()}pos=dataStart+4+compSize;while(pos<d.length-4){const a=d[pos],b=d[pos+1],c=d[pos+2],e=d[pos+3];if(((a===99||a===67)&&b===70&&c===73&&e===76))break;pos++}if(Object.keys(files).length>=4)break}
  return files;
}

// ============================================================
//  PNG DECODER
// ============================================================
async function extractCartData(dataURL) {
  const b64=dataURL.split(',')[1],bin=atob(b64),arr=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)arr[i]=bin.charCodeAt(i);const dv=new DataView(arr.buffer);let pos=8,width=0,height=0,idatChunks=[];
  while(pos<arr.length){const len=dv.getUint32(pos);const type=String.fromCharCode(arr[pos+4],arr[pos+5],arr[pos+6],arr[pos+7]);const dataStart=pos+8;if(type==='IHDR'){width=dv.getUint32(dataStart);height=dv.getUint32(dataStart+4)}else if(type==='IDAT')idatChunks.push(arr.slice(dataStart,dataStart+len));else if(type==='IEND')break;pos=dataStart+len+4}
  const totalLen=idatChunks.reduce((a,c)=>a+c.length,0);const compressed=new Uint8Array(totalLen);let off=0;for(const chunk of idatChunks){compressed.set(chunk,off);off+=chunk.length}
  const ds=new DecompressionStream('deflate');const writer=ds.writable.getWriter();writer.write(compressed);writer.close();const reader=ds.readable.getReader();const outChunks=[];while(true){const{done,value}=await reader.read();if(done)break;outChunks.push(value)}const rawTotal=outChunks.reduce((a,c)=>a+c.length,0);const raw=new Uint8Array(rawTotal);off=0;for(const c of outChunks){raw.set(c,off);off+=c.length}
  const stride=width*4;const pixels=new Uint8Array(width*height*4);for(let y=0;y<height;y++){const rowStart=y*(stride+1);const filter=raw[rowStart];const rowData=raw.subarray(rowStart+1,rowStart+1+stride);for(let x=0;x<stride;x++){let val=rowData[x];const a=(x>=4)?pixels[y*stride+x-4]:0;const b=(y>0)?pixels[(y-1)*stride+x]:0;const c_=(x>=4&&y>0)?pixels[(y-1)*stride+x-4]:0;switch(filter){case 0:break;case 1:val=(val+a)&0xFF;break;case 2:val=(val+b)&0xFF;break;case 3:val=(val+((a+b)>>1))&0xFF;break;case 4:{const p=a+b-c_;const pa=Math.abs(p-a),pb=Math.abs(p-b),pc=Math.abs(p-c_);val=(val+((pa<=pb&&pa<=pc)?a:(pb<=pc)?b:c_))&0xFF;break}}pixels[y*stride+x]=val}}
  const total=width*height;const cart=new Uint8Array(total);for(let i=0;i<total;i++){const r=pixels[i*4],g=pixels[i*4+1],b=pixels[i*4+2],a=pixels[i*4+3];cart[i]=((a&3)<<6)|((r&3)<<4)|((g&3)<<2)|(b&3)}return cart;
}

// ============================================================
//  BUILD RUNTIME HTML (with score interception)
// ============================================================
function buildRuntimeHTML(files, cartBytes, cartName, enableScoreCapture) {
  let shell=new TextDecoder().decode(files['shell.html']);
  const useWasm=!!files['pico8_wasm.js']&&!!files['pico8_wasm.wasm'];
  const jsRuntime=useWasm?new TextDecoder().decode(files['pico8_wasm.js']):new TextDecoder().decode(files['pico8.js']);
  const cartJS=`var _cartname=[\`${cartName}\`];\nvar _cartdat=[${cartBytes.join(',')}];\nvar _cdpos=0;\n`+jsRuntime;
  let bootstrap='<scr'+'ipt>\n';
  bootstrap+=`window.__p8_js_blob_url=URL.createObjectURL(new Blob([${JSON.stringify(cartJS)}],{type:'application/javascript'}));\n`;
  if(useWasm){const wd=files['pico8_wasm.wasm'];const chunks=[];for(let i=0;i<wd.length;i+=32768)chunks.push(String.fromCharCode.apply(null,wd.subarray(i,Math.min(i+32768,wd.length))));bootstrap+=`(function(){var _w='${btoa(chunks.join(''))}';var r=atob(_w),a=new Uint8Array(r.length);for(var i=0;i<r.length;i++)a[i]=r.charCodeAt(i);_w=null;window.__p8_wasm_binary=a.buffer;})();\n`}
  bootstrap+='</scr'+'ipt>\n';

  // Score capture: poll pico8_gpio[0] and [1] which map to PICO-8 addresses 0x5f80-0x5f81
  // The game writes: poke(0x5f80, score%256) poke(0x5f81, flr(score/256))
  let scoreCapture = '';
  if (enableScoreCapture) {
    scoreCapture = '<scr'+'ipt>\n'
      + 'var _lastScore = 0;\n'
      + 'var _scoreInterval = setInterval(function() {\n'
      + '  if (typeof pico8_gpio !== "undefined" && pico8_gpio) {\n'
      + '    var lo = pico8_gpio[0] || 0;\n'
      + '    var hi = pico8_gpio[1] || 0;\n'
      + '    var diff = pico8_gpio[2] || 0;\n'
      + '    var s = (hi * 256) + lo;\n'
      + '    if (s > 0 && s !== _lastScore) {\n'
      + '      _lastScore = s;\n'
      + '      window.parent.postMessage({ type: "p8score", score: s, difficulty: diff }, "*");\n'
      + '    }\n'
      + '  }\n'
      + '}, 500);\n'
      + '</scr'+'ipt>\n';
  }

  let helper='<scr'+'ipt>\nvar _p8b=setInterval(function(){if(typeof p8_run_cart==="function"&&typeof Module!=="undefined"&&Module.canvas){if(typeof p8_is_running==="undefined"||!p8_is_running)try{p8_run_cart()}catch(e){}clearInterval(_p8b)}},300);\n'
  +'if("ontouchstart" in window||navigator.maxTouchPoints>0){var _p8t=setInterval(function(){if(typeof p8_touch_detected!=="undefined"){p8_touch_detected=true;clearInterval(_p8t);}},300);}\n'
  +'</scr'+'ipt>\n';

  shell=shell.replace('var p8_autoplay = false;','var p8_autoplay = true;');
  shell=shell.replace('e.src = "##js_file##";','e.src = window.__p8_js_blob_url;');
  shell=shell.replace('Module = {};','Module = {}; if(window.__p8_wasm_binary) Module.wasmBinary = window.__p8_wasm_binary;');
  shell=shell.replace(/##label_file##/g,'');

  // pico8_gpio is already defined in shell.html, no need to re-init

  const si=shell.indexOf('<script');
  shell=(si>=0)?shell.substring(0,si)+bootstrap+shell.substring(si):bootstrap+shell;
  shell=shell.replace('</body>', scoreCapture + helper+'</body>');
  return shell;
}

// ============================================================
//  IndexedDB local cache
// ============================================================
function openLocalDB(){return new Promise((resolve,reject)=>{const req=indexedDB.open('p8l',2);req.onupgradeneeded=e=>{const db=e.target.result;if(!db.objectStoreNames.contains('d'))db.createObjectStore('d')};req.onsuccess=()=>resolve(req.result);req.onerror=()=>reject(req.error)})}
async function cacheRTLocal(buf){try{const db=await openLocalDB();db.transaction('d','readwrite').objectStore('d').put(buf,'rt')}catch(e){}}
async function loadRTLocal(){try{const db=await openLocalDB();return new Promise(res=>{const req=db.transaction('d','readonly').objectStore('d').get('rt');req.onsuccess=()=>res(req.result||null);req.onerror=()=>res(null)})}catch(e){return null}}

// ============================================================
//  SUPABASE — Runtime
// ============================================================
async function checkRemoteRuntime(){const{data}=sb.storage.from('pico8').getPublicUrl(RUNTIME_PATH);try{const resp=await fetch(data.publicUrl,{method:'HEAD'});return resp.ok?data.publicUrl:null}catch(e){return null}}
async function downloadRemoteRuntime(url){const resp=await fetch(url);if(!resp.ok)throw new Error('Download failed');return await resp.arrayBuffer()}
async function uploadRuntime(file){await sb.storage.from('pico8').remove([RUNTIME_PATH]);const{error}=await sb.storage.from('pico8').upload(RUNTIME_PATH,file,{contentType:'application/octet-stream',upsert:true});if(error)throw new Error('Upload failed: '+error.message)}

// ============================================================
//  SUPABASE — Cartridges
// ============================================================
async function fetchCartridges(){const{data,error}=await sb.from('cartridges').select('*').order('created_at',{ascending:true});if(error){console.error(error);return[]}return data||[]}
async function uploadCartridge(file,name,thumbDataURL){const uid=Date.now()+'_'+Math.random().toString(36).substr(2,8);const cartPath='carts/'+uid+'.png';const thumbPath='thumbs/'+uid+'.png';const{error:cartErr}=await sb.storage.from('pico8').upload(cartPath,file,{contentType:'image/png'});if(cartErr)throw new Error('Cart upload failed: '+cartErr.message);let thumbUrl=null;if(thumbDataURL){const thumbBlob=await fetch(thumbDataURL).then(r=>r.blob());const{error:thumbErr}=await sb.storage.from('pico8').upload(thumbPath,thumbBlob,{contentType:'image/png'});if(!thumbErr){const{data:td}=sb.storage.from('pico8').getPublicUrl(thumbPath);thumbUrl=td.publicUrl}}const{data:cd}=sb.storage.from('pico8').getPublicUrl(cartPath);const{data,error}=await sb.from('cartridges').insert({name,cart_url:cd.publicUrl,thumb_url:thumbUrl}).select().single();if(error)throw new Error('DB insert failed: '+error.message);return data}
async function updateCartridgeCategory(cartId, category){const{error}=await sb.from('cartridges').update({category}).eq('id',cartId);if(error)throw new Error('Update failed: '+error.message)}
async function deleteCartridge(cart){const cartPath=cart.cart_url.split('/storage/v1/object/public/pico8/')[1];if(cartPath)await sb.storage.from('pico8').remove([cartPath]);if(cart.thumb_url){const thumbPath=cart.thumb_url.split('/storage/v1/object/public/pico8/')[1];if(thumbPath)await sb.storage.from('pico8').remove([thumbPath])}await sb.from('cartridges').delete().eq('id',cart.id)}

// ============================================================
//  SUPABASE — Leaderboard
// ============================================================
async function fetchLeaderboard(gameName) {
  const { data, error } = await sb.from('leaderboard')
    .select('*')
    .eq('game_name', gameName)
    .order('score', { ascending: false })
    .limit(100);
  if (error) { console.error(error); return []; }
  return data || [];
}

async function deleteScore(id) {
  const { error } = await sb.from('leaderboard').delete().eq('id', id);
  if (error) throw new Error('Delete failed: ' + error.message);
}

async function submitScore(gameName, playerName, score, difficulty) {
  const diffNames = { 1: 'Easy', 2: 'Hard', 3: 'Nightmare' };
  const diffStr = diffNames[difficulty] || 'Easy';
  const { error } = await sb.from('leaderboard').insert({
    game_name: gameName,
    player_name: playerName,
    score: score,
    "Difficulty": diffStr
  });
  if (error) throw new Error('Submit failed: ' + error.message);
}

// ============================================================
//  UI STATE
// ============================================================
let runtimeFiles = null;
let cartridges = [];
let isAdmin = false;
let remoteRuntimeExists = false;
let currentGameCart = null; // cart object of currently playing game
let capturedScore = 0; // last score received from iframe
let capturedDifficulty = 0; // last difficulty received from iframe
let currentLBCart = null; // cart for leaderboard view
const $ = id => document.getElementById(id);

function log1(msg,cls){const el=$('log1');el.classList.add('on');el.innerHTML+='<div class="'+(cls||'')+'">'+msg+'</div>';el.scrollTop=el.scrollHeight}
function prog(p){$('pb1').classList.add('on');$('pf1').style.width=p+'%'}
function toast(m){const t=$('toast');t.textContent=m;t.classList.add('on');clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('on'),2500)}
function hideLoading(){$('step-loading').style.display='none'}
function showSetup(){hideLoading();$('step-setup').classList.add('on')}
function showLibrary(){hideLoading();$('step-setup').classList.remove('on');$('step-setup').style.display='none';$('step-library').classList.add('on');$('step-leaderboard').classList.remove('on')}
function updateRTStatus(){const el=$('rt-status');if(remoteRuntimeExists){el.className='rt-status';el.textContent='\u2713 Runtime uploaded and available for all users'}else{el.className='rt-status none';el.textContent='\u2717 No runtime uploaded yet'}}

function hasLeaderboard(cartName) {
  const n = cartName.toLowerCase().replace(/[^a-z0-9]/g, '');
  return LEADERBOARD_GAMES.some(g => g.replace(/[^a-z0-9]/g, '') === n);
}

// ===== ADMIN CATEGORIES =====
function renderAdminCategories(){
  const list=$('cat-list');
  list.innerHTML='';
  CART_CATEGORIES.forEach((cat,idx)=>{
    const item=document.createElement('div');item.className='cat-item';
    const nameDiv=document.createElement('div');nameDiv.className='cat-name';
    nameDiv.textContent=cat;
    if(idx===0){const star=document.createElement('span');star.textContent='⭐';star.title='Catégorie en vedette (affichée en grand)';star.style.cssText='margin-left:4px;font-size:9px;cursor:default;opacity:.8';nameDiv.appendChild(star)}
    nameDiv.onclick=()=>{
      const input=document.createElement('input');input.value=cat;
      nameDiv.textContent='';nameDiv.appendChild(input);input.focus();input.select();
      const save=async()=>{
        const n=input.value.trim();
        if(!n||n===cat){renderAdminCategories();return}
        const affected=cartridges.filter(c=>(c.category||CART_CATEGORIES[CART_CATEGORIES.length-1])===cat);
        for(const c of affected){await updateCartridgeCategory(c.id,n);c.category=n}
        CART_CATEGORIES[idx]=n;saveCategories();renderAdminCategories();renderCarts();toast('Catégorie renommée');
      };
      input.onblur=save;
      input.onkeydown=e=>{if(e.key==='Enter')input.blur();if(e.key==='Escape'){renderAdminCategories()}};
    };
    if(idx>0){
      const pinBtn=document.createElement('button');pinBtn.className='cat-pin';pinBtn.textContent='★';pinBtn.title='Mettre en vedette';
      pinBtn.onclick=()=>{CART_CATEGORIES.splice(idx,1);CART_CATEGORIES.unshift(cat);saveCategories();renderAdminCategories();renderCarts();toast('Catégorie mise en vedette')};
      item.appendChild(pinBtn);
    }
    const delBtn=document.createElement('button');delBtn.className='cat-del';delBtn.textContent='✕';
    delBtn.onclick=async()=>{
      if(CART_CATEGORIES.length<=1){toast('Il faut au moins une catégorie');return}
      const fallback=CART_CATEGORIES.find(c=>c!==cat)||CART_CATEGORIES[0];
      const affected=cartridges.filter(c=>(c.category||CART_CATEGORIES[CART_CATEGORIES.length-1])===cat);
      for(const c of affected){await updateCartridgeCategory(c.id,fallback);c.category=fallback}
      CART_CATEGORIES.splice(idx,1);saveCategories();renderAdminCategories();renderCarts();toast('Catégorie supprimée');
    };
    item.appendChild(nameDiv);item.appendChild(delBtn);list.appendChild(item);
  });
}

// ===== ADMIN =====
function showAdminModal(){$('modal-overlay').classList.add('on');$('modal-email').value='';$('modal-pw').value='';$('modal-error').style.display='none';setTimeout(()=>$('modal-email').focus(),100)}
function hideAdminModal(){$('modal-overlay').classList.remove('on')}
function enableAdmin(){isAdmin=true;$('admin-toggle').classList.add('active');$('admin-toggle').innerHTML='&#x1F513; Admin';$('admin-zone').classList.add('on');updateRTStatus();renderAdminCategories();renderCarts();toast('Admin mode on')}
function toggleAdmin(){if(isAdmin){sb.auth.signOut();isAdmin=false;$('admin-toggle').classList.remove('active');$('admin-toggle').innerHTML='&#x1F512; Admin';$('admin-zone').classList.remove('on');renderCarts();toast('Admin mode off')}else{showAdminModal()}}
async function tryLogin(){const{error}=await sb.auth.signInWithPassword({email:$('modal-email').value.trim(),password:$('modal-pw').value});if(error){$('modal-error').textContent='Email ou mot de passe incorrect';$('modal-error').style.display='block';$('modal-pw').value='';$('modal-pw').focus();return}enableAdmin();hideAdminModal()}

// ===== RUNTIME =====
function parseAndSetRuntime(buf){const files=parseDat(buf);if(!files['shell.html'])throw new Error('shell.html missing');if(!files['pico8_wasm.js']&&!files['pico8.js'])throw new Error('No JS runtime');runtimeFiles=files}
function handleDatLocal(file){const reader=new FileReader();reader.onprogress=e=>{if(e.lengthComputable)prog(e.loaded/e.total*40)};reader.onload=async()=>{try{prog(55);log1('Parsing runtime...','b');parseAndSetRuntime(reader.result);prog(100);log1('Runtime ready!','g');await cacheRTLocal(reader.result);setTimeout(showLibrary,400)}catch(e){log1('\u2717 '+e.message,'r');prog(0)}};reader.readAsArrayBuffer(file)}
async function handleDatAdmin(file){if(!isAdmin)return;toast('Uploading runtime...');try{await uploadRuntime(file);remoteRuntimeExists=true;updateRTStatus();const buf=await file.arrayBuffer();parseAndSetRuntime(buf);await cacheRTLocal(buf);toast('Runtime uploaded for all users!')}catch(e){toast('Error: '+e.message);console.error(e)}}

// ===== CARTRIDGES =====
function handleCarts(fileList){if(!isAdmin){toast('Admin mode required');return}for(const file of fileList){if(!file.name.toLowerCase().match(/\.p8\.png$|\.png$/))continue;const name=file.name.replace(/\.p8\.png$/i,'').replace(/\.png$/i,'');toast('Uploading '+name+'...');const reader=new FileReader();reader.onload=async()=>{try{const img=new Image();const thumbPromise=new Promise(res=>{img.onload=()=>{const c=document.createElement('canvas');c.width=160;c.height=205;const ctx=c.getContext('2d');ctx.imageSmoothingEnabled=false;ctx.drawImage(img,0,0);res(c.toDataURL())};img.onerror=()=>res(null);img.src=reader.result});const thumbDataURL=await thumbPromise;const cart=await uploadCartridge(file,name,thumbDataURL);cartridges.push(cart);renderCarts();toast('Added: '+name)}catch(e){toast('Error: '+e.message);console.error(e)}};reader.readAsDataURL(file)}}

async function removeCart(idx){if(!isAdmin)return;const cart=cartridges[idx];if(!cart)return;try{toast('Removing '+cart.name+'...');await deleteCartridge(cart);cartridges.splice(idx,1);renderCarts();toast('Removed: '+cart.name)}catch(e){toast('Error: '+e.message)}}

function renderCarts(){
  const grid=$('cart-grid'),empty=$('empty-msg');
  grid.innerHTML='';
  if(!cartridges.length){empty.style.display='block';return}
  empty.style.display='none';

  // Group by category — build effective list (CART_CATEGORIES + extras from DB)
  const groups={};
  CART_CATEGORIES.forEach(cat=>{groups[cat]=[]});
  cartridges.forEach((c,i)=>{const cat=c.category||CART_CATEGORIES[CART_CATEGORIES.length-1];if(!groups[cat])groups[cat]=[];groups[cat].push({c,i})});
  const pinnedCat=CART_CATEGORIES[0];
  const sortedRest=[...CART_CATEGORIES.slice(1),...Object.keys(groups).filter(c=>!CART_CATEGORIES.includes(c))].sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'}));
  const effectiveCats=pinnedCat?[pinnedCat,...sortedRest]:sortedRest;

  let sectionIdx=0;
  effectiveCats.forEach((cat)=>{
    const items=groups[cat];
    if(!items||!items.length)return;
    const section=document.createElement('div');
    const title=document.createElement('div');title.className='cart-section-title';title.textContent=cat;
    section.appendChild(title);
    const inner=document.createElement('div');inner.className='cart-grid-inner'+(sectionIdx===0?' featured':'');
    sectionIdx++;
    items.forEach(({c,i})=>{
      const card=document.createElement('div');
      card.className='cart-card';
      const ph='data:image/svg+xml,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128"><rect fill="#111" width="128" height="128"/></svg>');
      const thumbSrc=c.thumb_url||ph;
      const hasLB=hasLeaderboard(c.name);
      card.innerHTML='<div class="thumb"><img src="'+thumbSrc+'"></div>'
        +'<div class="cname"></div>'
        +'<div class="play-overlay">\u25B6</div>'
        +(hasLB?'<span class="trophy-icon">\u{1F3C6}</span>':'')
        +(isAdmin?'<button class="delete-btn">\u2715</button>':'');
      const cname=card.querySelector('.cname');cname.textContent=c.name;cname.title=c.name;
      if(isAdmin){
        card.querySelector('.delete-btn').onclick=e=>{e.stopPropagation();removeCart(i)};
        const sel=document.createElement('select');sel.className='cart-cat-select';
        CART_CATEGORIES.forEach(opt=>{const o=document.createElement('option');o.value=opt;o.textContent=opt;o.selected=(c.category||'Autres cartouches')===opt;sel.appendChild(o)});
        sel.onclick=e=>e.stopPropagation();
        sel.onchange=async e=>{e.stopPropagation();const newCat=e.target.value;try{await updateCartridgeCategory(c.id,newCat);c.category=newCat;renderCarts();toast('Catégorie mise à jour')}catch(err){toast('Erreur: '+err.message)}};
        card.appendChild(sel);
      }
      card.onclick=()=>{if(hasLB)showLeaderboard(c);else launchCart(i)};
      inner.appendChild(card);
    });
    section.appendChild(inner);
    grid.appendChild(section);
  });
}

// ===== LEADERBOARD =====
async function showLeaderboard(cart) {
  currentLBCart = cart;
  $('step-library').classList.remove('on');
  $('step-leaderboard').classList.add('on');
  $('lb-game-name').textContent = cart.name;
  $('lb-body').innerHTML = '';
  $('lb-empty').style.display = 'none';
  $('lb-table').style.display = 'none';
  currentLBFilter = 'all';
  document.querySelectorAll('.lb-filter').forEach(b => b.classList.toggle('active', b.dataset.diff === 'all'));

  $('lb-body').innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text2)"><span class="spinner"></span> Loading...</td></tr>';
  $('lb-table').style.display = '';

  currentLBScores = await fetchLeaderboard(cart.name);
  renderLeaderboard();
}

let currentLBScores = [];
let currentLBFilter = 'all';

function renderLeaderboard() {
  $('lb-body').innerHTML = '';
  const filtered = currentLBFilter === 'all' ? currentLBScores : currentLBScores.filter(s => s.Difficulty === currentLBFilter);

  if (!filtered.length) {
    $('lb-empty').style.display = 'block';
    $('lb-table').style.display = 'none';
    return;
  }

  $('lb-empty').style.display = 'none';
  $('lb-table').style.display = '';
  // Admin column header
  const thead = $('lb-table').querySelector('thead tr');
  if (isAdmin) {
    if (!thead.querySelector('.admin-del-th')) {
      const th = document.createElement('th');
      th.className = 'admin-del-th';
      th.style = 'width:24px';
      thead.appendChild(th);
    }
  } else {
    const oldTh = thead.querySelector('.admin-del-th');
    if (oldTh) oldTh.remove();
  }
  filtered.forEach((s, i) => {
    const tr = document.createElement('tr');
    const rankClass = i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : '';
    const diffColor = s.Difficulty === 'Nightmare' ? 'var(--accent)' : s.Difficulty === 'Hard' ? 'var(--yellow)' : 'var(--green)';
    const tdRank = document.createElement('td'); if (rankClass) tdRank.className = rankClass; tdRank.textContent = i + 1;
    const tdName = document.createElement('td'); tdName.textContent = s.player_name;
    const tdDiff = document.createElement('td'); tdDiff.style.cssText = 'color:'+diffColor+';font-size:9px'; tdDiff.textContent = s.Difficulty || '-';
    const tdScore = document.createElement('td'); tdScore.textContent = s.score;
    tr.appendChild(tdRank); tr.appendChild(tdName); tr.appendChild(tdDiff); tr.appendChild(tdScore);
    if (isAdmin) {
      const td = document.createElement('td');
      td.style = 'text-align:center;padding:4px';
      const btn = document.createElement('button');
      btn.textContent = '\u2715';
      btn.style = 'background:none;border:1px solid var(--border);color:var(--text2);font-size:10px;cursor:pointer;border-radius:3px;padding:1px 5px;font-family:inherit;transition:all .15s';
      btn.onmouseover = () => { btn.style.borderColor='var(--accent)'; btn.style.color='var(--accent)'; };
      btn.onmouseout = () => { btn.style.borderColor='var(--border)'; btn.style.color='var(--text2)'; };
      btn.onclick = async () => {
        if (!confirm('Supprimer le score de '+s.player_name+' ('+s.score+') ?')) return;
        try {
          await deleteScore(s.id);
          currentLBScores = currentLBScores.filter(x => x.id !== s.id);
          renderLeaderboard();
          toast('Score supprimé');
        } catch(e) { toast('Erreur: '+e.message); }
      };
      td.appendChild(btn);
      tr.appendChild(td);
    }
    $('lb-body').appendChild(tr);
  });
}

function hideLeaderboard() {
  $('step-leaderboard').classList.remove('on');
  $('step-library').classList.add('on');
  currentLBCart = null;
}

// ===== SCORE CAPTURE =====
window.addEventListener('message', e => {
  if (e.source !== $('gframe').contentWindow) return;
  if (e.data && e.data.type === 'p8score') {
    capturedScore = e.data.score;
    capturedDifficulty = e.data.difficulty || 0;
  }
});

function showScoreModal(score) {
  const diffNames = { 1: 'Easy', 2: 'Hard', 3: 'Nightmare' };
  capturedScore = score;
  $('score-display').textContent = score;
  $('score-diff').textContent = diffNames[capturedDifficulty] || '';
  $('score-name').value = '';
  $('score-overlay').classList.add('on');
  setTimeout(() => $('score-name').focus(), 100);
}

function hideScoreModal() {
  $('score-overlay').classList.remove('on');
}

async function handleScoreSubmit() {
  const name = $('score-name').value.trim();
  if (!name) { $('score-name').focus(); return; }
  if (!currentGameCart || capturedScore <= 0) { hideScoreModal(); return; }

  try {
    await submitScore(currentGameCart.name, name, capturedScore, capturedDifficulty);
    toast('Score submitted!');
    hideScoreModal();
    // Show leaderboard after submitting
    showLeaderboard(currentGameCart);
    currentGameCart = null;
  } catch(e) {
    toast('Error: ' + e.message);
  }
}

// ===== LAUNCH =====
async function launchCart(idx) {
  const cart = typeof idx === 'number' ? cartridges[idx] : idx;
  if (!runtimeFiles || !cart) return;
  try {
    toast('Loading '+cart.name+'...');
    capturedScore = 0;
    capturedDifficulty = 0;
    currentGameCart = hasLeaderboard(cart.name) ? cart : null;
    const resp = await fetch(cart.cart_url);
    const blob = await resp.blob();
    const dataURL = await new Promise(res=>{const r=new FileReader();r.onload=()=>res(r.result);r.readAsDataURL(blob)});
    const cartBytes = await extractCartData(dataURL);
    const enableScore = hasLeaderboard(cart.name);
    const html = buildRuntimeHTML(runtimeFiles, cartBytes, cart.name+'.p8', enableScore);
    $('gframe').src = URL.createObjectURL(new Blob([html],{type:'text/html'}));
    $('step-library').classList.remove('on');
    $('step-leaderboard').classList.remove('on');
    $('game').style.display='block';
    $('close-btn').classList.add('on');
    if(/Mobi|Android/i.test(navigator.userAgent))try{document.documentElement.requestFullscreen()}catch(e){}
  } catch(e) { toast('Error: '+e.message); console.error(e); }
}

function exitGame() {
  $('gframe').src='about:blank';
  $('game').style.display='none';
  $('close-btn').classList.remove('on');

  // If we captured a score from a leaderboard game, show the score modal
  if (currentGameCart && capturedScore > 0) {
    showScoreModal(capturedScore);
  } else {
    // Return to library or leaderboard
    if (currentLBCart) {
      showLeaderboard(currentLBCart);
    } else {
      $('step-library').classList.add('on');
    }
    currentGameCart = null;
  }

  if(document.fullscreenElement)document.exitFullscreen().catch(()=>{});
}

// ===== EVENTS =====
const dz1=$('dz1'),dz2=$('dz2'),dzRt=$('dz-rt');
dz1.addEventListener('dragover',e=>{e.preventDefault();dz1.classList.add('over')});
dz1.addEventListener('dragleave',()=>dz1.classList.remove('over'));
dz1.addEventListener('drop',e=>{e.preventDefault();dz1.classList.remove('over');if(e.dataTransfer.files[0])handleDatLocal(e.dataTransfer.files[0])});
$('f1').addEventListener('change',e=>{const f=e.target.files[0];if(f)handleDatLocal(f)});
dzRt.addEventListener('dragover',e=>{e.preventDefault();dzRt.classList.add('over')});
dzRt.addEventListener('dragleave',()=>dzRt.classList.remove('over'));
dzRt.addEventListener('drop',e=>{e.preventDefault();dzRt.classList.remove('over');if(e.dataTransfer.files[0])handleDatAdmin(e.dataTransfer.files[0])});
$('f-rt').addEventListener('change',e=>{const f=e.target.files[0];if(f)handleDatAdmin(f)});
dz2.addEventListener('dragover',e=>{e.preventDefault();dz2.classList.add('over')});
dz2.addEventListener('dragleave',()=>dz2.classList.remove('over'));
dz2.addEventListener('drop',e=>{e.preventDefault();dz2.classList.remove('over');handleCarts(e.dataTransfer.files)});
$('f2').addEventListener('change',e=>handleCarts(e.target.files));
$('close-btn').addEventListener('click',exitGame);
$('admin-toggle').addEventListener('click',toggleAdmin);
$('modal-cancel').addEventListener('click',hideAdminModal);
$('modal-ok').addEventListener('click',tryLogin);
$('modal-email').addEventListener('keydown',e=>{if(e.key==='Enter')$('modal-pw').focus()});
$('modal-pw').addEventListener('keydown',e=>{if(e.key==='Enter')tryLogin()});
$('modal-overlay').addEventListener('click',e=>{if(e.target===$('modal-overlay'))hideAdminModal()});
$('lb-back').addEventListener('click',hideLeaderboard);
$('cat-add').addEventListener('click',()=>{
  const newCat='Nouvelle catégorie';
  CART_CATEGORIES.push(newCat);saveCategories();
  renderAdminCategories();renderCarts();
  // Auto-ouvre le rename de la nouvelle catégorie
  const items=$('cat-list').querySelectorAll('.cat-name');
  if(items.length)items[items.length-1].click();
});
$('lb-play-btn').addEventListener('click',() => { if(currentLBCart) launchCart(currentLBCart); });
document.querySelectorAll('.lb-filter').forEach(btn => {
  btn.addEventListener('click', () => {
    currentLBFilter = btn.dataset.diff;
    document.querySelectorAll('.lb-filter').forEach(b => b.classList.toggle('active', b === btn));
    renderLeaderboard();
  });
});
$('score-skip').addEventListener('click',() => {
  hideScoreModal();
  if(currentGameCart && hasLeaderboard(currentGameCart.name)) {
    showLeaderboard(currentGameCart);
  } else {
    $('step-library').classList.add('on');
  }
  currentGameCart = null;
});
$('score-submit').addEventListener('click',handleScoreSubmit);
$('score-name').addEventListener('keydown',e=>{if(e.key==='Enter')handleScoreSubmit()});
$('score-overlay').addEventListener('click',e=>{if(e.target===$('score-overlay')){/* don't close on overlay click */}});
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    if($('score-overlay').classList.contains('on'))return; // don't dismiss score modal with Esc
    if($('modal-overlay').classList.contains('on'))hideAdminModal();
    else if($('game').style.display==='block')exitGame();
  }
});

// ===== INIT =====
(async()=>{
  $('load-status').innerHTML='<span class="spinner"></span> Checking runtime...';
  const localRT=await loadRTLocal();
  if(localRT){try{parseAndSetRuntime(localRT)}catch(e){}}
  const remoteUrl=await checkRemoteRuntime();
  remoteRuntimeExists=!!remoteUrl;
  if(!runtimeFiles&&remoteUrl){
    $('load-status').innerHTML='<span class="spinner"></span> Downloading runtime...';
    try{const buf=await downloadRemoteRuntime(remoteUrl);parseAndSetRuntime(buf);await cacheRTLocal(buf)}catch(e){console.error(e)}
  }
  $('load-status').innerHTML='<span class="spinner"></span> Loading cartridges...';
  await loadCategoriesFromSupabase();
  try{cartridges=await fetchCartridges()}catch(e){console.error(e)}
  // Restore admin session if still valid
  const{data:{session}}=await sb.auth.getSession();
  if(session)enableAdmin();
  if(runtimeFiles){showLibrary();renderCarts()}else{showSetup();renderCarts()}
})();
</script>
</body>
</html>
