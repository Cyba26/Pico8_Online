<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
<title>PICO-8 Web Launcher</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0d0d1a;--surface:#151528;--border:#252540;
  --accent:#ff004d;--accent-glow:#ff004d60;
  --green:#00e436;--blue:#29adff;--yellow:#ffec27;
  --pink:#ff77a8;--lavender:#83769c;
  --text:#fff;--text2:#7e7592;
}
body{
  font-family:'Courier New',monospace;
  background:var(--bg);color:var(--text);
  min-height:100vh;min-height:100dvh;
  display:flex;flex-direction:column;align-items:center;
  background-image:
    radial-gradient(ellipse at 20% 50%,#1a0a2e 0%,transparent 50%),
    radial-gradient(ellipse at 80% 20%,#0a1a2e 0%,transparent 50%);
}

/* ===== STEP 1: SETUP ===== */
#step-setup{max-width:480px;width:100%;padding:20px 16px;display:flex;flex-direction:column;gap:16px;align-items:center}
.logo{text-align:center;padding:24px 0 8px}
.logo img{height:40px;image-rendering:pixelated;filter:drop-shadow(0 0 12px var(--accent-glow))}
.logo .sub{font-size:10px;color:var(--text2);margin-top:8px;letter-spacing:1px}

.card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:18px;
  width:100%;transition:border-color .3s}
.card-head{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.badge{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;
  font-size:11px;font-weight:bold;background:var(--accent);color:#fff;flex-shrink:0}
.card-title{font-size:12px;font-weight:bold}
.card-desc{font-size:10px;color:var(--text2);margin-bottom:10px;line-height:1.5}

.dropzone{
  border:2px dashed var(--border);border-radius:8px;padding:24px 12px;
  text-align:center;cursor:pointer;transition:all .2s;font-size:11px;color:var(--text2);
  position:relative;overflow:hidden;
}
.dropzone:hover,.dropzone.over{border-color:var(--accent);background:#ff004d08;color:var(--text)}
.dropzone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;z-index:1}

.pbar{height:3px;background:#ffffff08;border-radius:2px;margin-top:8px;display:none;overflow:hidden}
.pbar.on{display:block}
.pfill{height:100%;background:var(--accent);width:0%;transition:width .25s;border-radius:2px}

.log{font-size:9px;color:var(--text2);max-height:70px;overflow-y:auto;margin-top:6px;
  padding:5px;background:#00000040;border-radius:3px;display:none;line-height:1.6;
  scrollbar-width:thin;scrollbar-color:var(--border) transparent}
.log.on{display:block}
.log .g{color:var(--green)}.log .r{color:var(--accent)}.log .b{color:var(--blue)}

/* ===== STEP 2: LIBRARY ===== */
#step-library{display:none;width:100%;max-width:600px;padding:12px 16px;flex-direction:column;gap:14px}
#step-library.on{display:flex}

.lib-header{display:flex;align-items:center;justify-content:space-between}
.lib-header img{height:28px;image-rendering:pixelated}
.reset-btn{font-size:9px;color:var(--text2);background:none;border:1px solid var(--border);
  padding:3px 8px;border-radius:4px;cursor:pointer;font-family:inherit;transition:all .15s}
.reset-btn:hover{border-color:var(--accent);color:var(--accent)}

.lib-drop{
  border:2px dashed var(--border);border-radius:8px;padding:16px;
  text-align:center;cursor:pointer;transition:all .2s;font-size:11px;color:var(--text2);
  position:relative;overflow:hidden;
}
.lib-drop:hover,.lib-drop.over{border-color:var(--blue);background:#29adff08;color:var(--text)}
.lib-drop input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;z-index:1}

.cart-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(110px, 1fr));
  gap:12px;
  margin-top:4px;
}
.cart-card{
  background:var(--surface);border:1px solid var(--border);border-radius:8px;
  overflow:hidden;cursor:pointer;transition:all .2s;position:relative;
}
.cart-card:hover{border-color:var(--blue);transform:translateY(-2px);
  box-shadow:0 4px 16px #29adff20}
.cart-card:active{transform:translateY(0)}
.cart-card .thumb{
  width:100%;aspect-ratio:160/205;background:#000;display:flex;align-items:center;justify-content:center;
  overflow:hidden;
}
.cart-card .thumb img{width:100%;height:100%;object-fit:cover;image-rendering:pixelated}
.cart-card .cname{
  padding:6px 8px;font-size:10px;text-align:center;
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text2);
}
.cart-card .play-overlay{
  position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,.5);opacity:0;transition:opacity .2s;font-size:28px;color:#fff;
  pointer-events:none;
}
.cart-card:hover .play-overlay{opacity:1}
.cart-card .delete-btn{
  position:absolute;top:4px;right:4px;width:18px;height:18px;border-radius:50%;
  background:#000a;border:1px solid #fff2;color:#fff8;font-size:10px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .15s;
  z-index:2;line-height:1;
}
.cart-card:hover .delete-btn{opacity:1}
.cart-card .delete-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent)}

.empty-lib{text-align:center;padding:32px 16px;color:var(--text2);font-size:11px;line-height:1.8}

/* ===== GAME SCREEN ===== */
#game{display:none;position:fixed;inset:0;background:#000;z-index:100}
#game iframe{width:100%;height:100%;border:none}
#close-btn{
  position:fixed;top:10px;right:10px;z-index:200;
  width:36px;height:36px;border-radius:50%;
  background:rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.15);
  color:rgba(255,255,255,.8);font-size:18px;line-height:1;
  cursor:pointer;display:none;
  backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);
  transition:all .15s;
  align-items:center;justify-content:center;
}
#close-btn.on{display:flex}
#close-btn:hover{background:var(--accent);border-color:var(--accent);color:#fff;transform:scale(1.1)}

/* scrollbar */
::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

/* toast */
#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(60px);
  background:var(--surface);border:1px solid var(--border);color:var(--text);
  padding:8px 16px;border-radius:6px;font-size:11px;font-family:inherit;
  transition:transform .3s,opacity .3s;opacity:0;z-index:300;white-space:nowrap}
#toast.on{transform:translateX(-50%) translateY(0);opacity:1}

/* saving indicator */
.saving-dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--green);
  margin-left:6px;animation:pulse 1s ease-in-out infinite;vertical-align:middle}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
</style>
</head>
<body>

<!-- STEP 1: Runtime setup (shown only first time) -->
<div id="step-setup">
  <div class="logo">
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAABZUlEQVR4Ae3dIY4CMRiA0SlBcRGynmuAISEcgGvggGRXrl25GgUHAC6B4AB4LvCvXgTB/JN05j2JaDvtR2sbAKCXStc+KJpp5G7YoVN7NvAf6DcBCAABIAAEgAAQAAJAAAgAASAABIAAEAACQAAIAAEgAASAAKjdsO0J47eJ1AlmP7nrv11S118mi+IGQAAIAAEgAASAABAAAkAACAABIAAEgAAQAAJAAAgAASAABIAAeFN5/iFiHKkzPs52/ZXdKffAP5f/ztwN4AlAAAgAASAABIAAEAACQAAIAAEgAASAABAAAkAACAABIAAEQNVK6zPeF5E5fIy+U5e/2R5Tx19/rVo9EzeAJwABIAAEgAAQAAJAAAgAASAABIAAEAACQAAIAAEgAASAABAAVStd+6CPfUTm+Nd56dSeuQE8AQgAASAABIAAEAACQAAIAAEgAASAABAAAkAACAABIAAEgAAAAKjOH1O0HaDSiFpiAAAAEHRFWHRMb2RlUE5HADIwMTEwMjIx41m2wQAAAABJRU5ErkJggg==" alt="PICO-8">
    <div class="sub">web launcher</div>
  </div>
  <div class="card" id="s1">
    <div class="card-head">
      <div class="badge">1</div>
      <div class="card-title">Load PICO-8 Runtime</div>
    </div>
    <div class="card-desc">
      Drop your <b>pico8.dat</b> file (from the Raspberry Pi build).<br>
      This only needs to be done once — it's cached locally.
    </div>
    <div class="dropzone" id="dz1">
      Drop pico8.dat here — or tap to browse
      <input type="file" id="f1" accept=".dat">
    </div>
    <div class="pbar" id="pb1"><div class="pfill" id="pf1"></div></div>
    <div class="log" id="log1"></div>
  </div>
</div>

<!-- STEP 2: Game library -->
<div id="step-library">
  <div class="lib-header">
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAABZUlEQVR4Ae3dIY4CMRiA0SlBcRGynmuAISEcgGvggGRXrl25GgUHAC6B4AB4LvCvXgTB/JN05j2JaDvtR2sbAKCXStc+KJpp5G7YoVN7NvAf6DcBCAABIAAEgAAQAAJAAAgAASAABIAAEAACQAAIAAEgAASAAKjdsO0J47eJ1AlmP7nrv11S118mi+IGQAAIAAEgAASAABAAAkAACAABIAAEgAAQAAJAAAgAASAABIAAeFN5/iFiHKkzPs52/ZXdKffAP5f/ztwN4AlAAAgAASAABIAAEAACQAAIAAEgAASAABAAAkAACAABIAAEQNVK6zPeF5E5fIy+U5e/2R5Tx19/rVo9EzeAJwABIAAEgAAQAAJAAAgAASAABIAAEAACQAAIAAEgAASAABAAVStd+6CPfUTm+Nd56dSeuQE8AQgAASAABIAAEAACQAAIAAEgAASAABAAAkAACAABIAAEgAAAAKjOH1O0HaDSiFpiAAAAEHRFWHRMb2RlUE5HADIwMTEwMjIx41m2wQAAAABJRU5ErkJggg==" alt="PICO-8" style="height:28px;image-rendering:pixelated">
    <button class="reset-btn" id="reset-rt">Change runtime</button>
  </div>
  <div class="lib-drop" id="dz2">
    + Drop .p8.png cartridges here — or tap to browse
    <input type="file" id="f2" accept=".png" multiple>
  </div>
  <div id="cart-area">
    <div class="empty-lib" id="empty-msg">
      No cartridges yet.<br>Drop some .p8.png files above to get started!
    </div>
    <div class="cart-grid" id="cart-grid"></div>
  </div>
</div>

<!-- GAME VIEW -->
<div id="game"><iframe id="gframe" sandbox="allow-scripts allow-same-origin"></iframe></div>
<button id="close-btn" title="Back to library">&#10005;</button>
<div id="toast"></div>

<script>
// ============================================================
//  LZ4 BLOCK DECOMPRESSOR
// ============================================================
function lz4Decompress(src, decompSize) {
  const out = new Uint8Array(decompSize);
  let si = 0, di = 0;
  while (si < src.length && di < decompSize) {
    const token = src[si++];
    let litLen = (token >> 4) & 0xF;
    if (litLen === 15) { let b; do { b = src[si++]; litLen += b; } while (b === 255); }
    if (si + litLen > src.length) { out.set(src.subarray(si), di); break; }
    out.set(src.subarray(si, si + litLen), di);
    si += litLen; di += litLen;
    if (di >= decompSize) break;
    if (si + 2 > src.length) break;
    const offset = src[si] | (src[si + 1] << 8); si += 2;
    if (offset === 0) break;
    let matchLen = (token & 0xF) + 4;
    if ((token & 0xF) === 15) { let b; do { b = src[si++]; matchLen += b; } while (b === 255); }
    let mPos = di - offset;
    if (mPos < 0) break;
    for (let j = 0; j < matchLen && di < decompSize; j++) out[di++] = out[mPos + j];
  }
  return out;
}

// ============================================================
//  CPOD / cFIL PARSER
// ============================================================
function parseDat(buf) {
  const d = new Uint8Array(buf);
  const dv = new DataView(buf);
  const needle = [112,111,100,47,102,95,104,116,109,108,53,46,112,111,100];
  let namePos = -1;
  outer: for (let i = 0; i < d.length - 15; i++) {
    for (let j = 0; j < 15; j++) { if (d[i+j] !== needle[j]) continue outer; }
    namePos = i; break;
  }
  if (namePos < 0) throw new Error('pod/f_html5.pod not found — invalid pico8.dat');
  const firstCfil = namePos + 64 + 76;
  const files = {};
  const wanted = new Set(['src/pico8.js','src/shell.html','src/pico8_wasm.js','src/pico8_wasm.wasm']);
  let pos = firstCfil;
  while (pos + 80 < d.length) {
    const m0 = d[pos], m1 = d[pos+1], m2 = d[pos+2], m3 = d[pos+3];
    const isCfil = (m0===99||m0===67) && m1===70 && m2===73 && m3===76;
    if (!isCfil) break;
    const isCompressed = (m0 === 99);
    const uncompSize = dv.getUint32(pos + 8, true);
    let ne = pos + 12;
    while (ne < pos + 76 && d[ne] !== 0) ne++;
    const name = String.fromCharCode.apply(null, d.subarray(pos + 12, ne));
    const dataStart = pos + 76;
    const compSize = dv.getUint32(dataStart, true);
    const compData = d.subarray(dataStart + 4, dataStart + 4 + compSize);
    if (wanted.has(name)) {
      files[name.split('/').pop()] = isCompressed ? lz4Decompress(compData, uncompSize) : compData.slice();
    }
    pos = dataStart + 4 + compSize;
    while (pos < d.length - 4) {
      const a = d[pos], b = d[pos+1], c = d[pos+2], e = d[pos+3];
      if (((a===99||a===67) && b===70 && c===73 && e===76)) break;
      pos++;
    }
    if (Object.keys(files).length >= 4) break;
  }
  return files;
}

// ============================================================
//  RAW PNG DECODER (avoids Canvas premultiplied alpha)
// ============================================================
async function extractCartData(dataURL) {
  const b64 = dataURL.split(',')[1];
  const bin = atob(b64);
  const arr = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);

  const dv = new DataView(arr.buffer);
  let pos = 8, width = 0, height = 0, idatChunks = [];
  while (pos < arr.length) {
    const len = dv.getUint32(pos);
    const type = String.fromCharCode(arr[pos+4], arr[pos+5], arr[pos+6], arr[pos+7]);
    const dataStart = pos + 8;
    if (type === 'IHDR') { width = dv.getUint32(dataStart); height = dv.getUint32(dataStart + 4); }
    else if (type === 'IDAT') idatChunks.push(arr.slice(dataStart, dataStart + len));
    else if (type === 'IEND') break;
    pos = dataStart + len + 4;
  }

  const totalLen = idatChunks.reduce((a, c) => a + c.length, 0);
  const compressed = new Uint8Array(totalLen);
  let off = 0;
  for (const chunk of idatChunks) { compressed.set(chunk, off); off += chunk.length; }

  const ds = new DecompressionStream('deflate');
  const writer = ds.writable.getWriter();
  writer.write(compressed); writer.close();
  const reader = ds.readable.getReader();
  const outChunks = [];
  while (true) { const {done, value} = await reader.read(); if (done) break; outChunks.push(value); }
  const rawTotal = outChunks.reduce((a, c) => a + c.length, 0);
  const raw = new Uint8Array(rawTotal);
  off = 0;
  for (const c of outChunks) { raw.set(c, off); off += c.length; }

  const stride = width * 4;
  const pixels = new Uint8Array(width * height * 4);
  for (let y = 0; y < height; y++) {
    const rowStart = y * (stride + 1);
    const filter = raw[rowStart];
    const rowData = raw.subarray(rowStart + 1, rowStart + 1 + stride);
    for (let x = 0; x < stride; x++) {
      let val = rowData[x];
      const a = (x >= 4) ? pixels[y * stride + x - 4] : 0;
      const b = (y > 0) ? pixels[(y-1) * stride + x] : 0;
      const c_ = (x >= 4 && y > 0) ? pixels[(y-1) * stride + x - 4] : 0;
      switch (filter) {
        case 0: break;
        case 1: val=(val+a)&0xFF; break;
        case 2: val=(val+b)&0xFF; break;
        case 3: val=(val+((a+b)>>1))&0xFF; break;
        case 4: { const p=a+b-c_; const pa=Math.abs(p-a),pb=Math.abs(p-b),pc=Math.abs(p-c_);
          val=(val+((pa<=pb&&pa<=pc)?a:(pb<=pc)?b:c_))&0xFF; break; }
      }
      pixels[y * stride + x] = val;
    }
  }

  const total = width * height;
  const cart = new Uint8Array(total);
  for (let i = 0; i < total; i++) {
    const r = pixels[i*4], g = pixels[i*4+1], b = pixels[i*4+2], a = pixels[i*4+3];
    cart[i] = ((a & 3) << 6) | ((r & 3) << 4) | ((g & 3) << 2) | (b & 3);
  }
  return cart;
}

// ============================================================
//  BUILD RUNTIME HTML
// ============================================================
function buildRuntimeHTML(files, cartBytes, cartName) {
  let shell = new TextDecoder().decode(files['shell.html']);
  const useWasm = !!files['pico8_wasm.js'] && !!files['pico8_wasm.wasm'];
  const jsRuntime = useWasm ? new TextDecoder().decode(files['pico8_wasm.js']) : new TextDecoder().decode(files['pico8.js']);

  const cartJS = `var _cartname=[\`${cartName}\`];\nvar _cartdat=[${cartBytes.join(',')}];\nvar _cdpos=0;\n` + jsRuntime;

  let bootstrap = '<scr'+'ipt>\n';
  bootstrap += `window.__p8_js_blob_url=URL.createObjectURL(new Blob([${JSON.stringify(cartJS)}],{type:'application/javascript'}));\n`;
  if (useWasm) {
    const wd = files['pico8_wasm.wasm'];
    const chunks = [];
    for (let i = 0; i < wd.length; i += 32768)
      chunks.push(String.fromCharCode.apply(null, wd.subarray(i, Math.min(i + 32768, wd.length))));
    bootstrap += `(function(){var _w='${btoa(chunks.join(''))}';var r=atob(_w),a=new Uint8Array(r.length);for(var i=0;i<r.length;i++)a[i]=r.charCodeAt(i);_w=null;window.__p8_wasm_binary=a.buffer;})();\n`;
  }
  bootstrap += '</scr'+'ipt>\n';

  let helper = '<scr'+'ipt>\nvar _p8b=setInterval(function(){if(typeof p8_run_cart==="function"&&typeof Module!=="undefined"&&Module.canvas){if(typeof p8_is_running==="undefined"||!p8_is_running)try{p8_run_cart()}catch(e){}clearInterval(_p8b)}},300);\n'
  + 'if("ontouchstart" in window||navigator.maxTouchPoints>0){var _p8t=setInterval(function(){if(typeof p8_touch_detected!=="undefined"){p8_touch_detected=true;clearInterval(_p8t);}},300);}\n'
  + '</scr'+'ipt>\n';

  shell = shell.replace('var p8_autoplay = false;', 'var p8_autoplay = true;');
  shell = shell.replace('e.src = "##js_file##";', 'e.src = window.__p8_js_blob_url;');
  shell = shell.replace('Module = {};', 'Module = {}; if(window.__p8_wasm_binary) Module.wasmBinary = window.__p8_wasm_binary;');
  shell = shell.replace(/##label_file##/g, '');

  const si = shell.indexOf('<script');
  shell = (si >= 0) ? shell.substring(0, si) + bootstrap + shell.substring(si) : bootstrap + shell;
  shell = shell.replace('</body>', helper + '</body>');
  return shell;
}

// ============================================================
//  IndexedDB — Runtime + Cartridges persistence
// ============================================================
const DB_NAME = 'p8l';
const DB_VERSION = 2; // bumped to add cartridges store

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = e => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains('d')) db.createObjectStore('d');
      if (!db.objectStoreNames.contains('carts')) db.createObjectStore('carts', { keyPath: 'id' });
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function saveRT(buf) {
  try {
    const db = await openDB();
    const tx = db.transaction('d', 'readwrite');
    tx.objectStore('d').put(buf, 'rt');
  } catch(e) {}
}

async function loadRT() {
  try {
    const db = await openDB();
    return new Promise(res => {
      const tx = db.transaction('d', 'readonly');
      const req = tx.objectStore('d').get('rt');
      req.onsuccess = () => res(req.result || null);
      req.onerror = () => res(null);
    });
  } catch(e) { return null; }
}

async function saveCart(cart) {
  try {
    const db = await openDB();
    const tx = db.transaction('carts', 'readwrite');
    tx.objectStore('carts').put(cart);
  } catch(e) { console.warn('Failed to save cart:', e); }
}

async function deleteCart(id) {
  try {
    const db = await openDB();
    const tx = db.transaction('carts', 'readwrite');
    tx.objectStore('carts').delete(id);
  } catch(e) { console.warn('Failed to delete cart:', e); }
}

async function loadAllCarts() {
  try {
    const db = await openDB();
    return new Promise(res => {
      const tx = db.transaction('carts', 'readonly');
      const req = tx.objectStore('carts').getAll();
      req.onsuccess = () => res(req.result || []);
      req.onerror = () => res([]);
    });
  } catch(e) { return []; }
}

// ============================================================
//  UI
// ============================================================
let runtimeFiles = null;
let cartridges = [];
const $ = id => document.getElementById(id);

function log1(msg, cls) { const el=$('log1');el.classList.add('on');el.innerHTML+='<div class="'+(cls||'')+'">'+msg+'</div>';el.scrollTop=el.scrollHeight; }
function prog(p) { $('pb1').classList.add('on'); $('pf1').style.width=p+'%'; }
function toast(m) { const t=$('toast');t.textContent=m;t.classList.add('on');clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('on'),2500); }

function showLibrary() { $('step-setup').style.display='none'; $('step-library').classList.add('on'); }

// ===== STEP 1 =====
function handleDat(file) {
  const reader = new FileReader();
  reader.onprogress = e => { if(e.lengthComputable) prog(e.loaded/e.total*40); };
  reader.onload = async () => {
    try {
      prog(55); log1('Parsing runtime...','b');
      const files = parseDat(reader.result);
      prog(80);
      for (const n of Object.keys(files)) log1('&#10003; '+n+' — '+(files[n].length/1024|0)+' KB','g');
      if (!files['shell.html']) throw new Error('shell.html missing');
      if (!files['pico8_wasm.js'] && !files['pico8.js']) throw new Error('No JS runtime');
      runtimeFiles = files;
      prog(100); log1('Runtime ready!','g');
      await saveRT(reader.result);
      setTimeout(showLibrary, 400);
    } catch(e) { log1('✗ '+e.message,'r'); prog(0); }
  };
  reader.readAsArrayBuffer(file);
}

// ===== STEP 2 =====
function handleCarts(fileList) {
  for (const file of fileList) {
    if (!file.name.toLowerCase().match(/\.p8\.png$|\.png$/)) continue;
    const reader = new FileReader();
    reader.onload = () => {
      const id = 'cart_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
      const name = file.name.replace(/\.p8\.png$/i,'').replace(/\.png$/i,'');
      const cartObj = { id, name, dataURL: reader.result, thumb: null };
      cartridges.push(cartObj);
      const img = new Image();
      img.onload = () => {
        const c = document.createElement('canvas'); c.width=160; c.height=205;
        const ctx = c.getContext('2d'); ctx.imageSmoothingEnabled = false;
        ctx.drawImage(img, 0, 0);
        cartObj.thumb = c.toDataURL();
        renderCarts();
        // Save to IndexedDB
        saveCart({ id: cartObj.id, name: cartObj.name, dataURL: cartObj.dataURL, thumb: cartObj.thumb });
        toast('Saved: ' + cartObj.name);
      };
      img.src = reader.result;
      renderCarts();
    };
    reader.readAsDataURL(file);
  }
}

async function removeCart(idx) {
  const cart = cartridges[idx];
  if (cart) {
    await deleteCart(cart.id);
    toast('Removed: ' + cart.name);
  }
  cartridges.splice(idx, 1);
  renderCarts();
}

function renderCarts() {
  const grid=$('cart-grid'), empty=$('empty-msg');
  grid.innerHTML = '';
  if (!cartridges.length) { empty.style.display='block'; return; }
  empty.style.display='none';

  cartridges.forEach((c,i) => {
    const card = document.createElement('div');
    card.className = 'cart-card';
    const ph = 'data:image/svg+xml,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128"><rect fill="#111" width="128" height="128"/></svg>');
    card.innerHTML = `<div class="thumb"><img src="${c.thumb||ph}"></div><div class="cname" title="${c.name}">${c.name}</div><div class="play-overlay">▶</div><button class="delete-btn">✕</button>`;
    card.querySelector('.delete-btn').onclick = e => { e.stopPropagation(); removeCart(i); };
    card.onclick = () => launchCart(i);
    grid.appendChild(card);
  });
}

// ===== LAUNCH =====
async function launchCart(idx) {
  if (!runtimeFiles || !cartridges[idx]) return;
  const cart = cartridges[idx];
  try {
    toast('Loading '+cart.name+'...');
    const cartBytes = await extractCartData(cart.dataURL);
    const html = buildRuntimeHTML(runtimeFiles, cartBytes, cart.name+'.p8');
    $('gframe').src = URL.createObjectURL(new Blob([html],{type:'text/html'}));
    $('step-library').classList.remove('on');
    $('game').style.display='block';
    $('close-btn').classList.add('on');
    if (/Mobi|Android/i.test(navigator.userAgent)) try{document.documentElement.requestFullscreen()}catch(e){}
  } catch(e) { toast('Error: '+e.message); }
}

function exitGame() {
  $('gframe').src='about:blank';
  $('game').style.display='none';
  $('close-btn').classList.remove('on');
  $('step-library').classList.add('on');
  if (document.fullscreenElement) document.exitFullscreen().catch(()=>{});
}

async function resetRuntime() {
  try {
    const db = await openDB();
    const tx = db.transaction(['d', 'carts'], 'readwrite');
    tx.objectStore('d').delete('rt');
    tx.objectStore('carts').clear();
    tx.oncomplete = () => location.reload();
  } catch(e) { location.reload(); }
}

// ===== EVENTS =====
const dz1=$('dz1'),dz2=$('dz2');
dz1.addEventListener('dragover',e=>{e.preventDefault();dz1.classList.add('over')});
dz1.addEventListener('dragleave',()=>dz1.classList.remove('over'));
dz1.addEventListener('drop',e=>{e.preventDefault();dz1.classList.remove('over');if(e.dataTransfer.files[0])handleDat(e.dataTransfer.files[0])});
$('f1').addEventListener('change',e=>{const f=e.target.files[0];if(f)handleDat(f);});
dz2.addEventListener('dragover',e=>{e.preventDefault();dz2.classList.add('over')});
dz2.addEventListener('dragleave',()=>dz2.classList.remove('over'));
dz2.addEventListener('drop',e=>{e.preventDefault();dz2.classList.remove('over');handleCarts(e.dataTransfer.files)});
$('f2').addEventListener('change',e=>handleCarts(e.target.files));
$('close-btn').addEventListener('click',exitGame);
$('reset-rt').addEventListener('click',resetRuntime);
document.addEventListener('keydown',e=>{if(e.key==='Escape'&&$('game').style.display==='block')exitGame()});

// ===== INIT =====
(async()=>{
  // Load runtime
  const saved = await loadRT();
  if (saved) {
    try {
      runtimeFiles = parseDat(saved);
      showLibrary();
    } catch(e) {}
  }
  // Load saved cartridges
  const savedCarts = await loadAllCarts();
  if (savedCarts.length) {
    cartridges = savedCarts;
    renderCarts();
  }
})();
</script>
</body>
</html>
